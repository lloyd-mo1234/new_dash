<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Regression Analysis - Swap Rate Analytics</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- Navigation -->
        <div class="navigation">
            <a href="/" class="nav-link">Charts</a>
            <a href="/regression" class="nav-link active">Regression</a>
        </div>

        <!-- Chart controls above chart -->
        <div class="chart-controls">
            <button id="load-curves-btn" class="load-curves-button">
                <span class="load-button-text">Load Curves</span>
                <span class="load-loading-spinner" style="display: none;">‚ü≥</span>
            </button>
            
            <button id="update-btn" class="update-button">
                <span class="button-text">Update Chart</span>
                <span class="loading-spinner" style="display: none;">‚ü≥</span>
            </button>
            
            <!-- Date selector buttons -->
            <button class="range-btn" data-range="1M">1M</button>
            <button class="range-btn" data-range="3M">3M</button>
            <button class="range-btn" data-range="6M">6M</button>
            <button class="range-btn" data-range="1Y">1Y</button>
            <button class="range-btn" data-range="3Y">3Y</button>
            <button class="range-btn" data-range="5Y">5Y</button>
            <button class="range-btn" data-range="10Y">10Y</button>
            <button class="range-btn active" data-range="MAX">Max</button>
            
            <!-- Custom date range selector -->
            <div class="custom-date-range">
                <span class="date-label">From:</span>
                <input type="text" id="from-date" class="date-input" placeholder="030520 or 3 May 2020">
                <span class="date-label">To:</span>
                <input type="text" id="to-date" class="date-input" placeholder="030521 or 3 May 2021">
                <button id="apply-custom-range" class="apply-date-btn">Apply</button>
            </div>
        </div>

        <!-- Chart area -->
        <div class="chart-container">
            <div id="chart-area">
                <div class="placeholder">
                    <h3>Ready for Regression Analysis</h3>
                    <p>Select Y and X variables, then press Enter to run regression</p>
                </div>
            </div>
        </div>
        
        <!-- Input controls at bottom -->
        <div class="controls">
            <div class="controls-layout">
                <div class="add-input-section">
                    <button id="add-input-btn" class="add-input-button">
                        <span>+ Add Input</span>
                    </button>
                </div>
                
                <div class="inputs-section">
                    <div class="input-group" data-input-id="1">
                        <label class="input-label">A</label>
                        <input 
                            type="text" 
                            id="tenor-input-1" 
                            placeholder="aud.1y1y" 
                            value="aud.1y1y"
                        />
                        <div class="button-controls">
                            <button class="axis-btn active" data-axis="left" title="Left Axis">L</button>
                            <button class="axis-btn" data-axis="right" title="Right Axis">R</button>
                            <button class="visibility-btn active" title="Show/Hide Line">üëÅ</button>
                            <button class="delete-btn" title="Delete">√ó</button>
                        </div>
                    </div>
                    <div class="input-group" data-input-id="2">
                        <label class="input-label">B</label>
                        <input 
                            type="text" 
                            id="tenor-input-2" 
                            placeholder="aud.2y2y or aud.5y5y.10y10y or 2*A or b-a" 
                            value=""
                        />
                        <div class="button-controls">
                            <button class="axis-btn active" data-axis="left" title="Left Axis">L</button>
                            <button class="axis-btn" data-axis="right" title="Right Axis">R</button>
                            <button class="visibility-btn active" title="Show/Hide Line">üëÅ</button>
                            <button class="delete-btn" title="Delete">√ó</button>
                        </div>
                    </div>
                    <div class="input-group" data-input-id="3">
                        <label class="input-label">C</label>
                        <input 
                            type="text" 
                            id="tenor-input-3" 
                            placeholder="aud.5y5y.10y10y.20y10y or 2*B-A-C" 
                            value=""
                        />
                        <div class="button-controls">
                            <button class="axis-btn active" data-axis="left" title="Left Axis">L</button>
                            <button class="axis-btn" data-axis="right" title="Right Axis">R</button>
                            <button class="visibility-btn active" title="Show/Hide Line">üëÅ</button>
                            <button class="delete-btn" title="Delete">√ó</button>
                        </div>
                    </div>
                    <div class="input-group" data-input-id="4">
                        <label class="input-label">D</label>
                        <input 
                            type="text" 
                            id="tenor-input-4" 
                            placeholder="aud.10y10y" 
                            value=""
                        />
                        <div class="button-controls">
                            <button class="axis-btn active" data-axis="left" title="Left Axis">L</button>
                            <button class="axis-btn" data-axis="right" title="Right Axis">R</button>
                            <button class="visibility-btn active" title="Show/Hide Line">üëÅ</button>
                            <button class="delete-btn" title="Delete">√ó</button>
                        </div>
                    </div>
                </div>
                
                <!-- Regression Variables Section -->
                <div class="regression-variables-section">
                    <div class="regression-variables-layout">
                        <!-- Y Variable Column -->
                        <div class="y-variable-column">
                            <div class="regression-header">
                                <span class="regression-title">Y Variable</span>
                            </div>
                            <div class="regression-dropdown-group">
                                <select id="y-variable-select" class="regression-dropdown">
                                </select>
                            </div>
                        </div>
                        
                        <!-- X Variables Column -->
                        <div class="x-variables-column">
                            <div class="regression-header">
                                <span class="regression-title">X Variables</span>
                            </div>
                            <div class="regression-dropdown-group">
                                <select id="x-variable-1" class="regression-dropdown">
                                </select>
                            </div>
                            <div class="regression-dropdown-group">
                                <select id="x-variable-2" class="regression-dropdown">
                                </select>
                            </div>
                            <div class="regression-dropdown-group">
                                <select id="x-variable-3" class="regression-dropdown">
                                </select>
                            </div>
                            <div class="regression-dropdown-group">
                                <select id="x-variable-4" class="regression-dropdown">
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="error-message" class="error-message" style="display: none;"></div>
    </div>

    <!-- Progress Bar Overlay -->
    <div id="progress-overlay" class="progress-overlay" style="display: none;">
        <div class="progress-container">
            <div class="progress-title">
                <span class="progress-spinner"></span>
                Loading Curve Data
            </div>
            <div class="progress-percentage" id="progress-percentage">0%</div>
            <div class="progress-bar-container">
                <div class="progress-bar" id="progress-bar"></div>
            </div>
            <div class="progress-text" id="progress-text">0 / 0 files</div>
            <div class="progress-message" id="progress-message">Initializing...</div>
        </div>
    </div>

    <script>
        const updateBtn = document.getElementById('update-btn');
        const loadCurvesBtn = document.getElementById('load-curves-btn');
        const addInputBtn = document.getElementById('add-input-btn');
        const controlsContainer = document.querySelector('.controls');
        const chartArea = document.getElementById('chart-area');
        const errorMessage = document.getElementById('error-message');
        const buttonText = document.querySelector('.button-text');
        const loadingSpinner = document.querySelector('.loading-spinner');
        const rangeButtons = document.querySelectorAll('.range-btn');
        const fromDateInput = document.getElementById('from-date');
        const toDateInput = document.getElementById('to-date');
        const applyCustomRangeBtn = document.getElementById('apply-custom-range');
        
        let tenorInputs = [
            document.getElementById('tenor-input-1'),
            document.getElementById('tenor-input-2'),
            document.getElementById('tenor-input-3'),
            document.getElementById('tenor-input-4')
        ];
        let inputCounter = 4;
        let currentRange = 'MAX';
        let progressInterval = null;
        let curvesLoaded = false;
        let chartUpdateInProgress = false;
        let chartUpdateTimeout = null;
        
        // Chart line colors (same as in Python)
        const chartColors = ['#00d4ff', '#ff6b6b', '#51cf66', '#ffd43b', '#9775fa', '#ff9f43', '#a55eea', '#26de81'];

        // Shared state management functions
        function saveSharedState() {
            const inputGroups = document.querySelectorAll('.input-group[data-input-id]');
            const sharedState = [];
            
            inputGroups.forEach((group) => {
                const input = group.querySelector('input');
                const label = group.querySelector('.input-label').textContent;
                const activeAxisBtn = group.querySelector('.axis-btn.active');
                const visibilityBtn = group.querySelector('.visibility-btn');
                
                sharedState.push({
                    label: label,
                    value: input.value,
                    axis: activeAxisBtn ? activeAxisBtn.getAttribute('data-axis') : 'left',
                    visible: visibilityBtn ? visibilityBtn.classList.contains('active') : true,
                    inputId: group.getAttribute('data-input-id')
                });
            });
            
            // Also save curve loading state and regression variable selections
            const regressionSelections = {
                yVariable: document.getElementById('y-variable-select').value,
                xVariables: [
                    document.getElementById('x-variable-1').value,
                    document.getElementById('x-variable-2').value,
                    document.getElementById('x-variable-3').value,
                    document.getElementById('x-variable-4').value
                ]
            };
            
            const globalState = {
                inputs: sharedState,
                curvesLoaded: curvesLoaded,
                inputCounter: inputCounter,
                regressionSelections: regressionSelections
            };
            
            localStorage.setItem('dashboardSharedState', JSON.stringify(globalState));
        }

        function loadSharedState() {
            const savedState = localStorage.getItem('dashboardSharedState');
            if (savedState) {
                try {
                    const globalState = JSON.parse(savedState);
                    
                    // Handle both old format (array) and new format (object)
                    let sharedState, savedCurvesLoaded, savedInputCounter;
                    
                    if (Array.isArray(globalState)) {
                        // Old format - just inputs
                        sharedState = globalState;
                        savedCurvesLoaded = false;
                        savedInputCounter = globalState.length;
                    } else {
                        // New format - object with inputs and state
                        sharedState = globalState.inputs || [];
                        savedCurvesLoaded = globalState.curvesLoaded || false;
                        savedInputCounter = globalState.inputCounter || sharedState.length;
                    }
                    
                    // Restore curve loading state from localStorage as initial state
                    curvesLoaded = savedCurvesLoaded;
                    updateLoadButtonState(curvesLoaded);
                    
                    // Clear existing inputs first
                    const existingInputs = document.querySelectorAll('.input-group[data-input-id]');
                    existingInputs.forEach(group => group.remove());
                    
                    // Reset tenorInputs array
                    tenorInputs = [];
                    
                    // Recreate all inputs from shared state
                    const inputsSection = document.querySelector('.inputs-section');
                    
                    sharedState.forEach((state, index) => {
                        // Create input group for each state entry
                        const inputGroup = document.createElement('div');
                        inputGroup.className = 'input-group';
                        inputGroup.setAttribute('data-input-id', state.inputId);
                        
                        const label = document.createElement('label');
                        label.className = 'input-label';
                        label.textContent = state.label;
                        
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.id = `tenor-input-${state.inputId}`;
                        input.placeholder = index === 0 ? 'aud.1y1y' : `aud.${state.label.toLowerCase()}.${state.label.toLowerCase()}`;
                        input.value = state.value;
                        
                        const buttonControls = document.createElement('div');
                        buttonControls.className = 'button-controls';
                        
                        const leftBtn = document.createElement('button');
                        leftBtn.className = `axis-btn ${state.axis === 'left' ? 'active' : ''}`;
                        leftBtn.setAttribute('data-axis', 'left');
                        leftBtn.setAttribute('title', 'Left Axis');
                        leftBtn.textContent = 'L';
                        
                        const rightBtn = document.createElement('button');
                        rightBtn.className = `axis-btn ${state.axis === 'right' ? 'active' : ''}`;
                        rightBtn.setAttribute('data-axis', 'right');
                        rightBtn.setAttribute('title', 'Right Axis');
                        rightBtn.textContent = 'R';
                        
                        const visibilityBtn = document.createElement('button');
                        visibilityBtn.className = `visibility-btn ${state.visible ? 'active' : ''}`;
                        visibilityBtn.setAttribute('title', 'Show/Hide Line');
                        visibilityBtn.textContent = state.visible ? 'üëÅ' : 'üôà';
                        
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'delete-btn';
                        deleteBtn.setAttribute('title', 'Delete');
                        deleteBtn.textContent = '√ó';
                        
                        buttonControls.appendChild(leftBtn);
                        buttonControls.appendChild(rightBtn);
                        buttonControls.appendChild(visibilityBtn);
                        buttonControls.appendChild(deleteBtn);
                        
                        inputGroup.appendChild(label);
                        inputGroup.appendChild(input);
                        inputGroup.appendChild(buttonControls);
                        
                        inputsSection.appendChild(inputGroup);
                        tenorInputs.push(input);
                        
                        // Add event listeners
                        input.addEventListener('keypress', function(e) {
                            if (e.key === 'Enter') {
                                updateChart();
                            }
                        });
                        
            input.addEventListener('input', function() {
                saveSharedState();
                updateRegressionDropdowns();
            });
            
            setupButtonListeners(inputGroup);
                    });
                    
                    inputCounter = savedInputCounter;
                    updateLabelColors();
                    
                    // Restore regression variable selections if they exist
                    if (globalState.regressionSelections) {
                        // Wait a bit for dropdowns to be populated, then restore selections
                        setTimeout(() => {
                            restoreRegressionSelections(globalState.regressionSelections);
                        }, 100);
                    }
                } catch (error) {
                    console.error('Error loading shared state:', error);
                }
            }
        }

        function addInputBoxFromState(state) {
            const inputGroup = document.createElement('div');
            inputGroup.className = 'input-group';
            inputGroup.setAttribute('data-input-id', state.inputId);
            
            const label = document.createElement('label');
            label.className = 'input-label';
            label.textContent = state.label;
            
            const input = document.createElement('input');
            input.type = 'text';
            input.id = `tenor-input-${state.inputId}`;
            input.placeholder = `aud.${state.label.toLowerCase()}.${state.label.toLowerCase()}`;
            input.value = state.value;
            
            const buttonControls = document.createElement('div');
            buttonControls.className = 'button-controls';
            
            const leftBtn = document.createElement('button');
            leftBtn.className = `axis-btn ${state.axis === 'left' ? 'active' : ''}`;
            leftBtn.setAttribute('data-axis', 'left');
            leftBtn.setAttribute('title', 'Left Axis');
            leftBtn.textContent = 'L';
            
            const rightBtn = document.createElement('button');
            rightBtn.className = `axis-btn ${state.axis === 'right' ? 'active' : ''}`;
            rightBtn.setAttribute('data-axis', 'right');
            rightBtn.setAttribute('title', 'Right Axis');
            rightBtn.textContent = 'R';
            
            const visibilityBtn = document.createElement('button');
            visibilityBtn.className = `visibility-btn ${state.visible ? 'active' : ''}`;
            visibilityBtn.setAttribute('title', 'Show/Hide Line');
            visibilityBtn.textContent = state.visible ? 'üëÅ' : 'üôà';
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn';
            deleteBtn.setAttribute('title', 'Delete');
            deleteBtn.textContent = '√ó';
            
            buttonControls.appendChild(leftBtn);
            buttonControls.appendChild(rightBtn);
            buttonControls.appendChild(visibilityBtn);
            buttonControls.appendChild(deleteBtn);
            
            inputGroup.appendChild(label);
            inputGroup.appendChild(input);
            inputGroup.appendChild(buttonControls);
            
            const inputsSection = document.querySelector('.inputs-section');
            inputsSection.appendChild(inputGroup);
            
            tenorInputs.push(input);
            
            // Add event listeners
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    updateChart();
                }
            });
            
            input.addEventListener('input', saveSharedState);
            
            setupButtonListeners(inputGroup);
        }

        function parseDateInput(dateStr) {
            if (!dateStr) return null;
            
            dateStr = dateStr.trim();
            
            // Format: 030520 (DDMMYY)
            if (/^\d{6}$/.test(dateStr)) {
                const day = parseInt(dateStr.substring(0, 2));
                const month = parseInt(dateStr.substring(2, 4));
                const year = 2000 + parseInt(dateStr.substring(4, 6));
                const date = new Date(year, month - 1, day);
                return formatDateToStandard(date);
            }
            
            // Format: 03/05/2020 or 03/05/20 or 3/5/20
            if (/^\d{1,2}\/\d{1,2}\/\d{2,4}$/.test(dateStr)) {
                const parts = dateStr.split('/');
                const day = parseInt(parts[0]);
                const month = parseInt(parts[1]);
                let year = parseInt(parts[2]);
                if (year < 100) year += 2000;
                const date = new Date(year, month - 1, day);
                return formatDateToStandard(date);
            }
            
            // Format: "3 May 2020" or similar
            const dateObj = new Date(dateStr);
            if (!isNaN(dateObj.getTime())) {
                return formatDateToStandard(dateObj);
            }
            
            return null;
        }

        function formatDateToStandard(date) {
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                          'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const day = date.getDate().toString().padStart(2, '0');
            const month = months[date.getMonth()];
            const year = date.getFullYear();
            return `${day} ${month} ${year}`;
        }

        function updateLabelColors() {
            const inputGroups = document.querySelectorAll('.input-group[data-input-id]');
            inputGroups.forEach((group, index) => {
                const label = group.querySelector('.input-label');
                const input = group.querySelector('input');
                const visibilityBtn = group.querySelector('.visibility-btn');
                
                // Only color if input has value and is visible
                if (input && input.value.trim() !== '' && visibilityBtn && visibilityBtn.classList.contains('active')) {
                    label.style.color = chartColors[index % chartColors.length];
                } else {
                    label.style.color = '#007acc'; // Default VS Code blue
                }
            });
        }

        function showLoading() {
            buttonText.style.display = 'none';
            loadingSpinner.style.display = 'inline';
            updateBtn.disabled = true;
        }

        function hideLoading() {
            buttonText.style.display = 'inline';
            loadingSpinner.style.display = 'none';
            updateBtn.disabled = false;
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 5000);
        }

        function showProgressBar() {
            document.getElementById('progress-overlay').style.display = 'flex';
            startProgressPolling();
        }

        function hideProgressBar() {
            document.getElementById('progress-overlay').style.display = 'none';
            stopProgressPolling();
        }

        function updateProgressBar(progressData) {
            // Handle new multi-currency progress structure
            let current, total, status, message;
            
            if (progressData.overall) {
                // New structure with overall progress
                current = progressData.overall.current || 0;
                total = progressData.overall.total || 0;
                status = progressData.overall.status || 'idle';
                message = progressData.overall.message || 'Processing...';
            } else {
                // Fallback to old structure
                current = progressData.current || 0;
                total = progressData.total || 0;
                status = progressData.status || 'idle';
                message = progressData.message || 'Processing...';
            }
            
            const percentage = total > 0 ? Math.round((current / total) * 100) : 0;
            
            document.getElementById('progress-percentage').textContent = `${percentage}%`;
            document.getElementById('progress-bar').style.width = `${percentage}%`;
            document.getElementById('progress-text').textContent = `${current} / ${total} files`;
            document.getElementById('progress-message').textContent = message;
            
            // Hide progress bar when complete
            if (status === 'complete') {
                setTimeout(() => {
                    hideProgressBar();
                }, 1000);
            }
        }

        function startProgressPolling() {
            // Only reset progress if curves aren't already loaded
            if (!curvesLoaded) {
                fetch('/reset_progress', { method: 'POST' });
            }
            
            progressInterval = setInterval(() => {
                fetch('/progress')
                    .then(response => response.json())
                    .then(data => {
                        updateProgressBar(data);
                        
                        // Check status from the correct location
                        let status = 'idle';
                        if (data.overall && data.overall.status) {
                            status = data.overall.status;
                        } else if (data.status) {
                            status = data.status;
                        }
                        
                        // Stop polling when complete or idle
                        if (status === 'complete' || status === 'idle') {
                            stopProgressPolling();
                        }
                    })
                    .catch(error => {
                        console.error('Progress polling error:', error);
                        stopProgressPolling();
                    });
            }, 200); // Poll every 200ms for smooth updates
        }

        function stopProgressPolling() {
            if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
            }
        }

        function addInputBox() {
            // Find the next sequential letter based on what's currently displayed
            const currentInputGroups = document.querySelectorAll('.input-group[data-input-id]');
            const nextLetterIndex = currentInputGroups.length; // 0=A, 1=B, 2=C, etc.
            const letter = String.fromCharCode(65 + nextLetterIndex); // A=65, B=66, etc.
            
            inputCounter++; // Still increment for unique IDs
            
            const inputGroup = document.createElement('div');
            inputGroup.className = 'input-group';
            inputGroup.setAttribute('data-input-id', inputCounter);
            
            const label = document.createElement('label');
            label.className = 'input-label';
            label.textContent = letter;
            
            const input = document.createElement('input');
            input.type = 'text';
            input.id = `tenor-input-${inputCounter}`;
            input.placeholder = `aud.${nextLetterIndex + 1}y.${nextLetterIndex + 1}y or ${letter}-A`;
            
            const buttonControls = document.createElement('div');
            buttonControls.className = 'button-controls';
            
            const leftBtn = document.createElement('button');
            leftBtn.className = 'axis-btn active';
            leftBtn.setAttribute('data-axis', 'left');
            leftBtn.setAttribute('title', 'Left Axis');
            leftBtn.textContent = 'L';
            
            const rightBtn = document.createElement('button');
            rightBtn.className = 'axis-btn';
            rightBtn.setAttribute('data-axis', 'right');
            rightBtn.setAttribute('title', 'Right Axis');
            rightBtn.textContent = 'R';
            
            const visibilityBtn = document.createElement('button');
            visibilityBtn.className = 'visibility-btn active';
            visibilityBtn.setAttribute('title', 'Show/Hide Line');
            visibilityBtn.textContent = 'üëÅ';
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn';
            deleteBtn.setAttribute('title', 'Delete');
            deleteBtn.textContent = '√ó';
            
            buttonControls.appendChild(leftBtn);
            buttonControls.appendChild(rightBtn);
            buttonControls.appendChild(visibilityBtn);
            buttonControls.appendChild(deleteBtn);
            
            inputGroup.appendChild(label);
            inputGroup.appendChild(input);
            inputGroup.appendChild(buttonControls);
            
            // Insert at the end of the inputs section (after all existing inputs)
            const inputsSection = document.querySelector('.inputs-section');
            inputsSection.appendChild(inputGroup);
            
            // Add to tenorInputs array
            tenorInputs.push(input);
            
            // Add event listeners
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    updateChart();
                }
            });
            
            input.addEventListener('input', function() {
                saveSharedState();
                updateRegressionDropdowns();
            });
            
            setupButtonListeners(inputGroup);
            
            input.focus();
            saveSharedState();
            updateRegressionDropdowns();
        }

        function setupButtonListeners(inputGroup) {
            const axisButtons = inputGroup.querySelectorAll('.axis-btn');
            const visibilityButton = inputGroup.querySelector('.visibility-btn');
            const deleteButton = inputGroup.querySelector('.delete-btn');
            
            axisButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    // Toggle axis selection within this input group
                    axisButtons.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    saveSharedState();
                    
                    // Use debounced update to prevent rapid requests
                    if (curvesLoaded) {
                        debouncedUpdateChart();
                    }
                });
            });
            
            if (visibilityButton) {
                visibilityButton.addEventListener('click', function() {
                    // Toggle visibility
                    this.classList.toggle('active');
                    // Update the eye icon based on state
                    this.textContent = this.classList.contains('active') ? 'üëÅ' : 'üôà';
                    
                    saveSharedState();
                    
                    // Use debounced update to prevent rapid requests
                    if (curvesLoaded) {
                        debouncedUpdateChart();
                    }
                });
            }
            
            deleteButton.addEventListener('click', function() {
                deleteInputGroup(inputGroup);
            });
        }

        function deleteInputGroup(inputGroup) {
            const inputId = inputGroup.getAttribute('data-input-id');
            const input = inputGroup.querySelector('input');
            
            // Remove from tenorInputs array
            const index = tenorInputs.indexOf(input);
            if (index > -1) {
                tenorInputs.splice(index, 1);
            }
            
            // Remove from DOM
            inputGroup.remove();
            
            // Relabel all remaining inputs sequentially
            relabelInputs();
            
            saveSharedState();
            
            // Update regression dropdowns after deletion
            updateRegressionDropdowns();
            
            // Update chart
            updateChart();
        }

        function relabelInputs() {
            const inputGroups = document.querySelectorAll('.input-group[data-input-id]');
            inputGroups.forEach((group, index) => {
                const label = group.querySelector('.input-label');
                const newLetter = String.fromCharCode(65 + index); // A=65, B=66, etc.
                label.textContent = newLetter;
                
                // Update placeholder to reflect new label
                const input = group.querySelector('input');
                if (input && input.placeholder.includes('or')) {
                    const basePlaceholder = input.placeholder.split(' or ')[0];
                    input.placeholder = `${basePlaceholder} or ${newLetter}-A`;
                }
            });
        }

        function checkCurvesStatus() {
            fetch('/curves_status')
                .then(response => response.json())
                .then(data => {
                    curvesLoaded = data.loaded;
                    if (curvesLoaded) {
                        // Curves are loaded, update button state and hide progress bar
                        updateLoadButtonState(true);
                        hideProgressBar();
                    } else {
                        // Check again in 1 second
                        setTimeout(checkCurvesStatus, 1000);
                    }
                })
                .catch(error => {
                    console.error('Error checking curves status:', error);
                    setTimeout(checkCurvesStatus, 2000);
                });
        }

        function updateLoadButtonState(loaded) {
            const loadButtonText = document.querySelector('.load-button-text');
            const loadLoadingSpinner = document.querySelector('.load-loading-spinner');
            
            console.log(`DEBUG: updateLoadButtonState called with loaded=${loaded}`);
            console.log(`DEBUG: Button classes before update:`, loadCurvesBtn.className);
            console.log(`DEBUG: Button text before update:`, loadButtonText.textContent);
            
            if (loaded) {
                // Curves are loaded - show "Curves Loaded" and change to lighter green
                loadButtonText.textContent = 'Curves Loaded';
                loadButtonText.style.display = 'inline';
                loadLoadingSpinner.style.display = 'none';
                loadCurvesBtn.disabled = false;
                loadCurvesBtn.classList.add('curves-loaded');
                console.log(`DEBUG: Set button to LOADED state`);
            } else {
                // Reset to original state
                loadButtonText.textContent = 'Load Curves';
                loadButtonText.style.display = 'inline';
                loadLoadingSpinner.style.display = 'none';
                loadCurvesBtn.disabled = false;
                loadCurvesBtn.classList.remove('curves-loaded');
                console.log(`DEBUG: Set button to NOT LOADED state`);
            }
            
            console.log(`DEBUG: Button classes after update:`, loadCurvesBtn.className);
            console.log(`DEBUG: Button text after update:`, loadButtonText.textContent);
        }

        function debouncedUpdateChart() {
            // Clear any existing timeout
            if (chartUpdateTimeout) {
                clearTimeout(chartUpdateTimeout);
            }
            
            // Set a new timeout for 500ms
            chartUpdateTimeout = setTimeout(() => {
                updateChart();
            }, 500);
        }

        function updateChart() {
            // For regression page, run regression instead of regular chart
            runRegression();
        }

        function runRegression() {
            // Check if curves are loaded first
            if (!curvesLoaded) {
                showError('Curves are still loading. Please wait...');
                return;
            }

            // Prevent multiple simultaneous updates
            if (chartUpdateInProgress) {
                console.log('Regression update already in progress, skipping...');
                return;
            }

            // Get selected variables
            const yVariableSelect = document.getElementById('y-variable-select');
            const xVariableSelects = [
                document.getElementById('x-variable-1'),
                document.getElementById('x-variable-2'),
                document.getElementById('x-variable-3'),
                document.getElementById('x-variable-4')
            ];

            const yVariable = yVariableSelect.value;
            const xVariables = xVariableSelects
                .map(select => select.value)
                .filter(value => value.trim() !== '');

            if (!yVariable) {
                showError('Please select a Y variable');
                return;
            }

            if (xVariables.length === 0) {
                showError('Please select at least one X variable');
                return;
            }

            // Get the actual expressions from input groups
            const inputGroups = document.querySelectorAll('.input-group[data-input-id]');
            const variableMap = {};
            
            inputGroups.forEach((group) => {
                const input = group.querySelector('input');
                const label = group.querySelector('.input-label').textContent;
                
                if (input && input.value.trim() !== '') {
                    variableMap[label] = input.value.trim();
                }
            });

            // Map selected variables to their expressions
            const yExpression = variableMap[yVariable];
            const xExpressions = xVariables.map(variable => variableMap[variable]);

            if (!yExpression || xExpressions.some(expr => !expr)) {
                showError('Selected variables must have valid expressions');
                return;
            }

            chartUpdateInProgress = true;
            showLoading();
            errorMessage.style.display = 'none';

            fetch('/run_regression', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    y_variable: yExpression,
                    x_variables: xExpressions,
                    range: currentRange
                })
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                chartUpdateInProgress = false;
                
                if (data.error) {
                    showError(data.error);
                    return;
                }

                // Display regression results
                displayRegressionResults(data);
            })
            .catch(error => {
                hideLoading();
                chartUpdateInProgress = false;
                showError('Network error: ' + error.message);
            });
        }

        function displayRegressionResults(data) {
            const chartArea = document.getElementById('chart-area');
            
            // Create new layout for regression results
            chartArea.innerHTML = `
                <div class="regression-results-container">
                    <div class="charts-row">
                        <div class="chart-half" id="scatter-chart"></div>
                        <div class="chart-half" id="residuals-chart"></div>
                    </div>
                    <div class="statistics-section">
                        <div class="statistics-table" id="summary-statistics"></div>
                        <div class="statistics-table" id="coefficients-table"></div>
                    </div>
                </div>
            `;

            // Plot scatter chart
            if (data.charts && data.charts.scatter) {
                const scatterData = JSON.parse(data.charts.scatter);
                Plotly.newPlot('scatter-chart', scatterData.data, scatterData.layout, {
                    responsive: true,
                    displayModeBar: true,
                    modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d'],
                    displaylogo: false
                });
            }

            // Plot residuals chart
            if (data.charts && data.charts.residuals) {
                const residualsData = JSON.parse(data.charts.residuals);
                Plotly.newPlot('residuals-chart', residualsData.data, residualsData.layout, {
                    responsive: true,
                    displayModeBar: true,
                    modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d'],
                    displaylogo: false
                });
            }

            // Display statistics
            if (data.statistics) {
                displayStatistics(data.statistics);
            }
        }

        function displayStatistics(statistics) {
            const summaryStatsDiv = document.getElementById('summary-statistics');
            const coefficientsDiv = document.getElementById('coefficients-table');
            
            if (!statistics || statistics.error) {
                summaryStatsDiv.innerHTML = '<p class="error">Error loading statistics</p>';
                coefficientsDiv.innerHTML = '';
                return;
            }

            const stats = statistics.statistics;
            const coeffs = statistics.coefficients;

            // Summary statistics section
            let summaryHtml = `
                <div class="stats-summary">
                    <div class="stats-row">
                        <span class="stat-label">R-squared:</span>
                        <span class="stat-value">${stats.r_squared}</span>
                        <span class="stat-label">Adj R-squared:</span>
                        <span class="stat-value">${stats.adj_r_squared}</span>
                        <span class="stat-label">Std Error:</span>
                        <span class="stat-value">${stats.std_error}</span>
                    </div>
                    <div class="stats-row">
                        <span class="stat-label">F-statistic:</span>
                        <span class="stat-value">${stats.f_statistic}</span>
                        <span class="stat-label">F p-value:</span>
                        <span class="stat-value">${stats.f_p_value}</span>
                        <span class="stat-label">Observations:</span>
                        <span class="stat-value">${stats.n_observations}</span>
                    </div>
                </div>
            `;

            // Coefficients table section
            let coefficientsHtml = `
                <div class="coefficients-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Variable</th>
                                <th>Coefficient</th>
                                <th>Std Error</th>
                                <th>t-statistic</th>
                                <th>p-value</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            coeffs.forEach(coeff => {
                coefficientsHtml += `
                    <tr>
                        <td>${coeff.variable}</td>
                        <td>${coeff.coefficient}</td>
                        <td>${coeff.std_error}</td>
                        <td>${coeff.t_statistic}</td>
                        <td>${coeff.p_value}</td>
                    </tr>
                `;
            });

            coefficientsHtml += `
                        </tbody>
                    </table>
                </div>
            `;

            summaryStatsDiv.innerHTML = summaryHtml;
            coefficientsDiv.innerHTML = coefficientsHtml;
        }

        function loadCurves() {
            const loadButtonText = document.querySelector('.load-button-text');
            const loadLoadingSpinner = document.querySelector('.load-loading-spinner');
            
            // Show loading state on button
            loadButtonText.style.display = 'none';
            loadLoadingSpinner.style.display = 'inline';
            loadCurvesBtn.disabled = true;
            
            // Show progress bar
            showProgressBar();
            
            // Start loading curves
            fetch('/start_loading', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        checkCurvesStatus();
                    } else {
                        showError('Failed to start curve loading');
                        hideProgressBar();
                        // Reset button state
                        loadButtonText.style.display = 'inline';
                        loadLoadingSpinner.style.display = 'none';
                        loadCurvesBtn.disabled = false;
                    }
                })
                .catch(error => {
                    showError('Error starting curve loading: ' + error.message);
                    hideProgressBar();
                    // Reset button state
                    loadButtonText.style.display = 'inline';
                    loadLoadingSpinner.style.display = 'none';
                    loadCurvesBtn.disabled = false;
                });
        }

        // Event listeners
        updateBtn.addEventListener('click', updateChart);
        loadCurvesBtn.addEventListener('click', loadCurves);
        addInputBtn.addEventListener('click', addInputBox);
        
        tenorInputs.forEach(input => {
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    updateChart();
                }
            });
            
            input.addEventListener('input', saveSharedState);
        });

        // Range button event listeners
        rangeButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                rangeButtons.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentRange = this.dataset.range;
                updateChart();
            });
        });

        // Date input event listeners
        fromDateInput.addEventListener('blur', function() {
            const parsed = parseDateInput(this.value);
            if (parsed) {
                this.value = parsed;
            }
        });

        toDateInput.addEventListener('blur', function() {
            const parsed = parseDateInput(this.value);
            if (parsed) {
                this.value = parsed;
            }
        });

        applyCustomRangeBtn.addEventListener('click', function() {
            const fromDate = fromDateInput.value.trim();
            const toDate = toDateInput.value.trim();
            
            if (!fromDate || !toDate) {
                showError('Please enter both from and to dates');
                return;
            }
            
            // For now, just show a message that custom date ranges are not yet implemented
            showError('Custom date ranges will be implemented in a future update');
        });

        // Setup initial button listeners for existing input groups
        document.querySelectorAll('.input-group[data-input-id]').forEach(group => {
            setupButtonListeners(group);
        });

        // Function to restore regression variable selections
        function restoreRegressionSelections(selections) {
            if (!selections) return;
            
            // Restore Y variable selection
            const yVariableSelect = document.getElementById('y-variable-select');
            if (selections.yVariable && yVariableSelect) {
                yVariableSelect.value = selections.yVariable;
            }
            
            // Restore X variable selections
            const xVariableSelects = [
                document.getElementById('x-variable-1'),
                document.getElementById('x-variable-2'),
                document.getElementById('x-variable-3'),
                document.getElementById('x-variable-4')
            ];
            
            if (selections.xVariables && Array.isArray(selections.xVariables)) {
                selections.xVariables.forEach((value, index) => {
                    if (xVariableSelects[index] && value) {
                        xVariableSelects[index].value = value;
                    }
                });
            }
        }

        // Regression variable management functions
        function updateRegressionDropdowns() {
            const inputGroups = document.querySelectorAll('.input-group[data-input-id]');
            const yVariableSelect = document.getElementById('y-variable-select');
            const xVariableSelects = [
                document.getElementById('x-variable-1'),
                document.getElementById('x-variable-2'),
                document.getElementById('x-variable-3'),
                document.getElementById('x-variable-4')
            ];
            
            // Save current selections before clearing
            const currentYSelection = yVariableSelect.value;
            const currentXSelections = xVariableSelects.map(select => select.value);
            
            // Clear existing options and add blank option
            yVariableSelect.innerHTML = '<option value=""></option>';
            xVariableSelects.forEach((select, index) => {
                select.innerHTML = '<option value=""></option>';
            });
            
            // Add options for each input that has a value
            inputGroups.forEach((group) => {
                const input = group.querySelector('input');
                const label = group.querySelector('.input-label').textContent;
                
                if (input && input.value.trim() !== '') {
                    // Add to Y variable dropdown
                    const yOption = document.createElement('option');
                    yOption.value = label;
                    yOption.textContent = `${label}: ${input.value.trim()}`;
                    yVariableSelect.appendChild(yOption);
                    
                    // Add to each X variable dropdown
                    xVariableSelects.forEach((select) => {
                        const xOption = document.createElement('option');
                        xOption.value = label;
                        xOption.textContent = `${label}: ${input.value.trim()}`;
                        select.appendChild(xOption);
                    });
                }
            });
            
            // Restore previous selections after rebuilding dropdowns
            yVariableSelect.value = currentYSelection;
            currentXSelections.forEach((selection, index) => {
                if (xVariableSelects[index]) {
                    xVariableSelects[index].value = selection;
                }
            });
        }
        
        // Handle charts link click
        document.querySelector('a[href="/"]').addEventListener('click', function(e) {
            e.preventDefault();
            
            // Save current state before navigating
            saveSharedState();
            
            // Navigate to charts page
            window.location.href = '/';
        });

        // Initialize on page load
        window.addEventListener('load', function() {
            // Load shared state first
            loadSharedState();
            
            // Update regression dropdowns after loading state
            updateRegressionDropdowns();
            
            // Add event listeners to regression dropdowns to save selections when changed
            const yVariableSelect = document.getElementById('y-variable-select');
            const xVariableSelects = [
                document.getElementById('x-variable-1'),
                document.getElementById('x-variable-2'),
                document.getElementById('x-variable-3'),
                document.getElementById('x-variable-4')
            ];
            
            yVariableSelect.addEventListener('change', saveSharedState);
            xVariableSelects.forEach(select => {
                select.addEventListener('change', saveSharedState);
            });
            
            // Focus on first input
            if (tenorInputs.length > 0) {
                tenorInputs[0].focus();
            }
            
            // Always check server status to verify curves are actually loaded
            // Don't trust saved state for curve loading status
            fetch('/curves_status')
                .then(response => response.json())
                .then(data => {
                    curvesLoaded = data.loaded;
                    updateLoadButtonState(curvesLoaded);
                    // Update saved state with actual server status
                    saveSharedState();
                })
                .catch(error => {
                    console.error('Error checking curves status:', error);
                    // Default to not loaded on error
                    curvesLoaded = false;
                    updateLoadButtonState(curvesLoaded);
                    saveSharedState();
                });
        });
    </script>
</body>
</html>
